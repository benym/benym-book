(window.webpackJsonp=window.webpackJsonp||[]).push([[86],{413:function(t,e,a){"use strict";a.r(e);var s=a(7),n=Object(s.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h3",{attrs:{id:"redis持久化aof"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#redis持久化aof"}},[t._v("#")]),t._v(" Redis持久化AOF")]),t._v(" "),e("p",[t._v("Redis主要包含2中持久化方式，即RDB和AOF，本文主要介绍AOF，RDB见本站的另一篇博客"),e("a",{attrs:{href:"https://cloud.benym.cn/benym-book/pages/2f1bf8/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Redis持久化RDB"),e("OutboundLink")],1)]),t._v(" "),e("h4",{attrs:{id:"什么是aof"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#什么是aof"}},[t._v("#")]),t._v(" 什么是AOF")]),t._v(" "),e("p",[t._v("AOF全称为Append Only File（追加文件）。Redis处理的每一个"),e("strong",[t._v("写命令")]),t._v("都会记录在AOF文件，可以看做是命令日志文件。\nAOF默认是关闭的，需要修改"),e("code",[t._v("redis.conf")]),t._v("配置文件来开启AOF：")]),t._v(" "),e("div",{staticClass:"language-java line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[t._v("# 是否开启"),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("AOF")]),t._v("功能，默认是no\nappendonly yes\n# "),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("AOF")]),t._v("文件的名称\nappendfilename "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"appendonly.aof"')]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br")]),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br")])]),e("p",[t._v("AOF的命令记录的频率也可以通过redis.conf文件来配：")]),t._v(" "),e("div",{staticClass:"language-java line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[t._v("# 表示每执行一次写命令，立即记录到"),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("AOF")]),t._v("文件\nappendfsync always \n# 写命令执行完先放入"),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("AOF")]),t._v("缓冲区，然后表示每隔"),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("秒将缓冲区数据写到"),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("AOF")]),t._v("文件，是默认方案\nappendfsync everysec \n# 写命令执行完先放入"),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("AOF")]),t._v("缓冲区，由操作系统决定何时将缓冲区内容写回磁盘\nappendfsync no\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br")]),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br")])]),e("div",{staticClass:"center-container"},[e("p",[t._v("配置项对比")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"center"}},[t._v("配置项")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("刷盘时机")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("优点")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("缺点")])])]),t._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("Always")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("同步刷盘")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("可靠性高，几乎不丢数据")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("性能影响大")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("everysec")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("每秒刷盘")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("性能适中")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("最多丢失1秒数据")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("no")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("操作系统控制")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("性能最好")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("可靠性较差，可能丢失大量数据")])])])])]),e("p",[t._v("因为是记录命令，AOF文件会比RDB文件大的多。而且AOF会记录对同一个key的多次写操作，但只有最后一次写操作才有意义。通过执行"),e("code",[t._v("bgrewriteaof")]),t._v("命令，可以让AOF文件执行重写功能，用最少的命令达到相同效果。")]),t._v(" "),e("div",{staticClass:"center-container"},[e("img",{staticStyle:{zoom:"60%"},attrs:{src:"https://image-1-1257237419.cos.ap-chongqing.myqcloud.com/redisImg/redisAOF.png/zipstyle",alt:"AOF重写"}})]),e("p",[t._v("Redis也会在触发阈值时自动去重写AOF文件。阈值也可以在redis.conf中配置：")]),t._v(" "),e("div",{staticClass:"language-java line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[t._v("# "),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("AOF")]),t._v("文件比上次文件 增长超过多少百分比则触发重写\nauto"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("aof"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("rewrite"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("percentage "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v("\n# "),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("AOF")]),t._v("文件体积最小多大以上才触发重写\nauto"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("aof"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("rewrite"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("min"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("size "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v("mb \n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br")]),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br")])]),e("h4",{attrs:{id:"重写原理-如何实现重写"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#重写原理-如何实现重写"}},[t._v("#")]),t._v(" 重写原理，如何实现重写")]),t._v(" "),e("p",[t._v("AOF文件持续增长而过大时，会fork出一条新进程来将文件重写(也是先写临时文件最后再rename)，redis4.0版本后的重写，是指上就是把rdb 的快照，以二级制的形式附在新的aof头部，作为已有的历史数据，替换掉原来的流水账操作。\n关键命令"),e("code",[t._v("no-appendfsync-on-rewrite")])]),t._v(" "),e("ul",[e("li",[t._v("如果"),e("code",[t._v("no-appendfsync-on-rewrite=yes")]),t._v(",不写入aof文件只写入缓存，用户请求不会阻塞，但是在这段时间如果宕机会丢失这段时间的缓存数据。（降低数据安全性，提高性能）")]),t._v(" "),e("li",[t._v("如果"),e("code",[t._v("no-appendfsync-on-rewrite=no")]),t._v(",  还是会把数据往磁盘里刷，但是遇到重写操作，可能会发生阻塞。（数据安全，但是性能降低）")])]),t._v(" "),e("h5",{attrs:{id:"重写流程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#重写流程"}},[t._v("#")]),t._v(" 重写流程")]),t._v(" "),e("ol",[e("li",[e("code",[t._v("bgrewriteaof")]),t._v("触发重写，判断是否当前有"),e("code",[t._v("bgsave")]),t._v("或"),e("code",[t._v("bgrewriteaof")]),t._v("在运行，如果有，则等待该命令结束后再继续执行。")]),t._v(" "),e("li",[t._v("主进程"),e("code",[t._v("fork")]),t._v("出子进程执行重写操作，保证主进程不会阻塞。")]),t._v(" "),e("li",[t._v("子进程遍历redis内存中数据到临时文件，客户端的写请求同时写入"),e("code",[t._v("aof_buf")]),t._v("缓冲区和"),e("code",[t._v("aof_rewrite_buf")]),t._v("重写缓冲区保证原AOF文件完整以及新AOF文件生成期间的新的数据修改动作不会丢失。")]),t._v(" "),e("li",[t._v("(1).子进程写完新的AOF文件后，向主进程发信号，父进程更新统计信息。(2).主进程把aof_rewrite_buf中的数据写入到新的AOF文件。")]),t._v(" "),e("li",[t._v("使用新的AOF文件覆盖旧的AOF文件，完成AOF重写。\n如图所示")])]),t._v(" "),e("div",{staticClass:"center-container"},[e("img",{staticStyle:{zoom:"60%"},attrs:{src:"https://image-1-1257237419.cos.ap-chongqing.myqcloud.com/redisImg/redisAOFrewrite.png/zipstyle",alt:"AOF重写流程"}})]),e("h4",{attrs:{id:"aof持久化流程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#aof持久化流程"}},[t._v("#")]),t._v(" AOF持久化流程")]),t._v(" "),e("ol",[e("li",[t._v("客户端的请求写命令会被append追加到AOF缓冲区内；")]),t._v(" "),e("li",[t._v("AOF缓冲区根据AOF持久化策略[always,everysec,no]将操作sync同步到磁盘的AOF文件中；")]),t._v(" "),e("li",[t._v("AOF文件大小超过重写策略或手动重写时，会对AOF文件rewrite重写，压缩AOF文件容量；")]),t._v(" "),e("li",[t._v("Redis服务重启时，会重新load加载AOF文件中的写操作达到数据恢复的目的；")])]),t._v(" "),e("h4",{attrs:{id:"总结-与rdb对比"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#总结-与rdb对比"}},[t._v("#")]),t._v(" 总结-与RDB对比")]),t._v(" "),e("div",{staticClass:"center-container"},[e("p",[t._v("RDB和AOF各有自己的优缺点，如果对数据安全性要求较高，在实际开发中往往会结合两者来使用。")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"center"}}),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("RDB")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("AOF")])])]),t._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("持久化方式")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("定时对整个内存做快照")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("记录每一次执行的命令")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("数据完整性")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("不完整，两次备份之间会丢失")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("相对完整，取决于刷盘策略")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("文件大小")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("会有压缩，文件体积小")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("记录命令，文件体积很大")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("宕机恢复速度")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("很快")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("慢")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("数据恢复优先级")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("低，因为数据完整性不如AOF")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("高，因为数据完整性更高")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("系统资源占用")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("高，大量CPU和内存消耗")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("低，主要是磁盘IO资源  但AOF重写时会占用大量CPU和内存资源")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("使用场景")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("可以容忍数分钟的数据丢失，追求更快的启动速度")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("对数据安全性要求较高常见")])])])])])])}),[],!1,null,null,null);e.default=n.exports}}]);