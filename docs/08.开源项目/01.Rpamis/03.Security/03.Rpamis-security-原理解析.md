---
title: Rpamis-security-原理解析
categories: 
  - 开源项目
  - Rpamis
  - Security
  - Mybatis
  - Plugin
  - 加解密
  - 脱敏
  - 数据安全
tags: 
  - 开源项目
  - Rpamis
  - Mybatis
  - Plugin
  - 加解密
  - 脱敏
  - Security
  - 原理解析
article: false
author: 
  name: benym
  link: https://github.com/benym
date: 2023-11-29 16:31:41
permalink: /pages/1ffe0d/
---
## 核心组件

[rpamis-security](https://github.com/benym/rpamis-security)<Badge text="1.0.0"/>主要通过`Mybatis-Plugin`及`AOP`切面实现安全功能，其主要组件如下图所示

::: center
<img src="https://image-1-1257237419.cos.ap-chongqing.myqcloud.com/rpas/rpamis-security-arch.jpg" />
:::

## Mybatis插件前置知识

在`Mybatis`中预留有`org.apache.ibatis.plugin.Interceptor`接口，通过实现该接口，开发者能够对`Mybatis`的执行流程进行拦截

```java
public interface Interceptor {
    Object intercept(Invocation var1) throws Throwable;

    default Object plugin(Object target) {
        return Plugin.wrap(target, this);
    }

    default void setProperties(Properties properties) {
    }
}
```

三个方法的解释通常为

- **【intercept】**：插件执行的具体流程，传入的`Invocation`是`MyBatis`对被代理的方法的封装。
- **【plugin】**：使用当前的`Interceptor`创建代理，通常的实现都是`Plugin.wrap(target, this)`，`wrap`方法内使用`jdk`创建动态代理对象。
- **【setProperties】**：参考下方代码，在`MyBatis`配置文件中配置插件时可以设置参数，在`setProperties`函数中调用`Properties.getProperty("param1")`方法可以得到配置的值。

```java
<plugins>
    <plugin interceptor="com.xx.xx.xxxInterceptor">
        <property name="param1" value="value1"/>
    </plugin>
</plugins>
```

### 插件原理

项目在启动时，`Mybatis`的`org.apache.ibatis.builder.xml.XMLConfigBuilder#parseConfiguration`方法内的`pluginElement`方法会解析配置文件中的`plugins`节点

::: center
<img src="https://image-1-1257237419.cos.ap-chongqing.myqcloud.com/rpas/rpamis-se1.png" />
:::

::: center
<img src="https://image-1-1257237419.cos.ap-chongqing.myqcloud.com/rpas/rpamis-se2.png" />
:::

之后`configuration`的`addInterceptor`方法会将拦截器加入到拦截器链中

::: center
<img src="https://image-1-1257237419.cos.ap-chongqing.myqcloud.com/rpas/rpamis-se3.png" />
:::

在执行`SQL`时，所有的插件都会依次执行

对于一个`Mybatis`的操作而言，其能够被代理的几个概念为

- **【Executor】**: 真正执行`SQL`语句的对象，调用`sqlSession`的方法时，本质上都是调用`executor`的方法，还负责获取`connection`，创建`StatementHandler`。
- **【StatementHandler】**: 创建并持有`ParameterHandler`和`ResultSetHandler`对象，操作`JDBC`的`statement`与进行数据库操作。
- **【ParameterHandler】**: 处理入参，将`Java`方法上的参数设置到被执行语句中。
- **【ResultSetHandler】**: 处理`SQL`语句的执行结果，将返回值转换为`Java`对象。

执行顺序由前到后

可以配合对应注解实现对不同阶段不同执行方法的拦截

```java
@Intercepts({ @Signature(type = Executor.class, method = "update", args = { MappedStatement.class, Object.class }),
        @Signature(type = Executor.class, method = "query", args = { MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class }) })
```

比如这里是在`Executor`阶段对`update`和`query`方法进行拦截

### 普通SQL加密插件-MybatisEncryptInterceptor

对于一个基本的字段加密功能，可如网络中常见的教程一样，拦截`ParameterHandler`阶段的`setParameters`方法，因为此时正是处理`Java`参数和执行语句的时间

本项目也采用了这种处理方式

1. 首先获取真正需要处理的对象，并从中获取对应的参数

```java
if (!(invocation.getTarget() instanceof ParameterHandler)) {
    return invocation.proceed();
}
ParameterHandler statementHandler = PluginUtils.realTarget(invocation.getTarget());
MetaObject metaObject = SystemMetaObject.forObject(statementHandler);
// 如果是select操作，或者mybatis-plus的@SqlParser(filter = true)跳过该方法解析，不进行验证
MappedStatement mappedStatement = (MappedStatement) metaObject.getValue("mappedStatement");
if (SqlCommandType.SELECT.equals(mappedStatement.getSqlCommandType())) {
    return invocation.proceed();
}
ParameterHandler parameterHandler = (ParameterHandler) invocation.getTarget();
Object parameterObject = parameterHandler.getParameterObject();
if (Objects.isNull(parameterObject)) {
    return invocation.proceed();
}
```

2. 对于返回值是`List`类型且包含`Mybatis-Plus`实体`key`的进行通用加密处理

```java
// mybatis对于List类型的处理，底层默认为Map类型
if (parameterObject instanceof Map) {
    Map<String, Object> parameterObjectMap = (Map<String, Object>) parameterObject;
    // 如果不包含mybatis-plus的实体key
    if (parameterObjectMap.containsKey(Constants.ENTITY)) {
        Object entity = parameterObjectMap.get(Constants.ENTITY);
        if (entity != null) {
            // 深拷贝复制
            Object deepCloneEntity = SerializationUtils.deepClone(entity);
            if (Objects.nonNull(deepCloneEntity)) {
                // 进行加密
                Object encryptObject = securityResolver.encryptFiled(deepCloneEntity);
                parameterObjectMap.put(Constants.ENTITY, encryptObject);
            }
        }
    }
}
```

通常而言`SQL`的返回值可分为`List`、`Map`、`DO实体`、`Page`对象等，其中`Mybatis`会将`List`最终转化为`Map`进行处理，所以针对`List`和`Map`对象，其解析步骤一致

### 动态SQL加密插件-MybatisDynamicSqlEncryptInterceptor



###解密插件-MybatisDecryptInterceptor



### 脱敏切面







