---
title: 无惧性能烦恼!12款Bean拷贝工具压测大比拼
date: 2022-11-17 23:06:41
permalink: /pages/2c8c1a/
categories:
  - 开源项目
  - Rpas
tags:
  - 工具类
  - BeanUtil
  - 压测
  - JMH
---

## 背景

在开发过程中，我们通常会用到DO、DTO、VO、PO等对象，一般来说这些对象之间的字段具有一定的相似性。在进行对象转换时，除了手动get/set之外，开发者大概率会使用到类似BeanUtils等对象拷贝工具类。由于许多拷贝工具类性能低下，开发者经常在工具类没有进行选型的情况下引入项目，造成了开发社区或公司对这类工具类使用时有了更多的性能担忧。在前期的调研当中，也有类似于本文的比较，大多数使用循环/StopWatch/计算执行时间等形式衡量，少数文章采用了压测的方法。这类评价方式，能反应出一定的性能问题，但通常实验做的不够严谨准确。

本文将对比市面上10款常见拷贝工具+1款基本封装的个人工具+1原生get/set方法，采用JMH进行公平性压测比较。以此让我们对工具类有一个清晰的对比，选择出合适的工具类。

实验代码 [https://github.com/benym/benchmark-test](https://github.com/benym/benchmark-test)

## 对比方法

 - get/set: 原生get/set
 - RpasBeanUtils: 基于Cglib BeanCopier+ConcurrentReferenceHashMap封装、基于ASM字节码拷贝原理
 - MapStruct: 编译器生成get/set、浅拷贝
 - BeanCopier: 原生Cglib BeanCopier、基于ASM字节码拷贝原理
 - JackSon: Spring官方JackSon序列化工具ObjectMapper
 - FastJson: Alibaba Json序列化工具
 - Hutool BeanUtil: Hutool提供的BeanUtil工具
 - Hutool CglibUtil: Hutool提供的Cglib工具、基于Cglib BeanCopier、ASM字节码拷贝
 - Spring BeanUtils: Spring官方提供的BeanUtils、基于反射
 - Apache BeanUtils: 基于反射
 - Orkia: 基于javassist类库生成Bean映射的字节码
 - Dozer: 基于反射、定制化属性映射、XML映射

## 实验设置

本次实验只针对各工具类最核心接口，为了进行公平性比较，测试时将对需要动态根据source、target创建拷贝对象的工具类(RpasBeanUtils、MapStruct、BeanCopier、Jackson、Hutool BeanUtil、Hutool CglibUtil、Orkia、Dozer)进行实例缓存、同时对源数据进行缓存，尽可能展示核心拷贝接口的性能。实际上在日常开发过程中，开发者对于经常使用的工具类也会选择用static final修饰，或采用诸如Map等进行实例缓存。或许是碍于需要每个给对比工具类增加缓存操作的工作量，**在调研的文章中很少有考虑对实例进行缓存的操作**，造成比如BeanCopier实验效果和MapStruct差异过大等问题。

在JMH中我们可以通过`@State(Scope.Benchmark)`+`@Setup(Level.Trial)`注解轻松实现在基准测试开始前的缓存初始化

### 基准参数设置
实验环境
 - jmhVersion : 1.29
 - IntelliJ IDEA 2021.2.2
 - jdkVersion : 1.8.0_351
 - CPU : Intel(R) Core(TM) i5-10600KF CPU @ 4.10GHz
 - Fork : 1, 对于每个Benchmark Fork出一个线程，避免实验数据倾斜
 - BenchmarkModel : Mode.Throughput, 采用吞吐量作为衡量指标
 - Warmup : 3, JIT预热3次之后进入正式测试
 - Measurement : iterations=10、time=5, 每个Benchmark迭代10次，每次迭代5秒
 - OutputTimeUnit : TimeUnit.MILLISECONDS, 吞吐量时间单位ops/ms
 - Threads : 10, 生成10个线程进行发压

### 实验对象

本次实验有2组对象
 - 简单类型对象DataBaseDO、DataBaseVO，简单类型仅有5个字段；
 - 复杂类型对象DbDO、DbVo、MockOne、MockTwo，复杂类型对象中包含108个字段，且字段中存在MockOne、MockTwo对象，在MockOne中包含其自身的嵌套子集`List<MockOne>`

## 实验结果

结果中Score表示测试的吞吐量，Error表示测试结果的平均差

 1. 程序运行结果
```java
简单对象
        
Benchmark                                 Mode  Cnt       Score     Error   Units
BenchmarkTestSimple.testApacheBeanUtils  thrpt   10    1014.681 ±   5.442  ops/ms
BenchmarkTestSimple.testBeanCopier       thrpt   10  341581.539 ± 668.458  ops/ms
BenchmarkTestSimple.testDozerMapping     thrpt   10    1444.746 ±   6.486  ops/ms
BenchmarkTestSimple.testFastJson         thrpt   10    9816.492 ±  64.882  ops/ms
BenchmarkTestSimple.testGetSet           thrpt   10  341429.391 ± 407.244  ops/ms
BenchmarkTestSimple.testHutoolBeanUtil   thrpt   10    1201.178 ±  14.053  ops/ms
BenchmarkTestSimple.testHutoolCglibUtil  thrpt   10  340730.983 ± 757.836  ops/ms
BenchmarkTestSimple.testJackSon          thrpt   10    7333.661 ±  36.987  ops/ms
BenchmarkTestSimple.testMapStruct        thrpt   10  341577.692 ± 487.573  ops/ms
BenchmarkTestSimple.testOrikaMapper      thrpt   10    2377.357 ±   3.422  ops/ms
BenchmarkTestSimple.testRpasBeanUtils    thrpt   10  340737.565 ± 774.559  ops/ms
BenchmarkTestSimple.testSpringBeanUtils  thrpt   10    1949.802 ±   2.807  ops/ms
```

```java
复杂对象

Benchmark                                  Mode  Cnt      Score     Error   Units
BenchmarkTestComplex.testApacheBeanUtils  thrpt   10     34.609 ±   0.405  ops/ms
BenchmarkTestComplex.testBeanCopier       thrpt   10  24113.092 ± 127.129  ops/ms
BenchmarkTestComplex.testDozerMapping     thrpt   10     96.133 ±   0.676  ops/ms
BenchmarkTestComplex.testFastJson         thrpt   10    226.692 ±   1.215  ops/ms
BenchmarkTestComplex.testGetSet           thrpt   10  24200.668 ±  43.997  ops/ms
BenchmarkTestComplex.testHutoolBeanUtil   thrpt   10     68.630 ±   0.161  ops/ms
BenchmarkTestComplex.testHutoolCglibUtil  thrpt   10  24147.446 ±  80.792  ops/ms
BenchmarkTestComplex.testJackSon          thrpt   10    256.080 ±   2.660  ops/ms
BenchmarkTestComplex.testMapStruct        thrpt   10  24111.832 ± 100.456  ops/ms
BenchmarkTestComplex.testOrikaMapper      thrpt   10   1775.526 ±   1.818  ops/ms
BenchmarkTestComplex.testRpasBeanUtils    thrpt   10  24109.377 ± 160.851  ops/ms
BenchmarkTestComplex.testSpringBeanUtils  thrpt   10     94.354 ±   0.694  ops/ms
```
 2. 数值可视化 
简单对象

![image-20221117225232188](https://image-1-1257237419.cos.ap-chongqing.myqcloud.com/rpas/image-20221117225232188.png)


复杂对象

![image-20221117225323448](https://image-1-1257237419.cos.ap-chongqing.myqcloud.com/rpas/image-20221117225323448.png)

 3. CPU频率图

![cpu](https://image-1-1257237419.cos.ap-chongqing.myqcloud.com/rpas/cpu.png)
